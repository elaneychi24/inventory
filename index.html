<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, viewport-fit=cover">
    <title>Daily Byte Tracker</title>
    
    <!-- PWA Tags for iPhone -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    
    <style>
        :root { --sat: env(safe-area-inset-top); --sab: env(safe-area-inset-bottom); }
        html, body { height: 100dvh; margin: 0; overflow: hidden; position: fixed; width: 100%; background: #f8fafc; }
        body { display: flex; flex-direction: column; }
        main { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding-bottom: 160px; }
        
        /* Fixed Video Sizing */
        #reader { 
            width: 100% !important; 
            border: none !important; 
            border-radius: 24px; 
            overflow: hidden; 
            background: #000;
        }
        #reader__scan_region video {
            object-fit: cover !important;
            border-radius: 24px;
        }

        /* Scan Guide Overlay */
        .scan-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 250px;
            height: 150px;
            border: 2px solid rgba(255,255,255,0.5);
            border-radius: 12px;
            pointer-events: none;
            z-index: 10;
        }
        .scan-overlay::after {
            content: "ALIGN BARCODE HERE";
            position: absolute;
            bottom: -25px;
            left: 0;
            right: 0;
            text-align: center;
            color: white;
            font-size: 10px;
            font-weight: 900;
            letter-spacing: 1px;
        }

        .toast { visibility: hidden; min-width: 200px; background: #0f172a; color: #fff; text-align: center; border-radius: 50px; padding: 12px 20px; position: fixed; z-index: 100; left: 50%; transform: translateX(-50%); bottom: 120px; font-size: 12px; font-weight: 800; }
        .toast.show { visibility: visible; animation: pop 0.3s ease-out; }
        @keyframes pop { from { opacity: 0; transform: translate(-50%, 20px); } to { opacity: 1; transform: translate(-50%, 0); } }
    </style>
</head>
<body class="text-slate-900">

    <div id="toast" class="toast">Updated</div>

    <!-- Header -->
    <header class="bg-white border-b border-slate-200 px-6 py-4 pt-[calc(1rem+var(--sat))]">
        <div class="max-w-xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-lg font-black tracking-tighter uppercase italic">The Daily <span class="text-blue-600">Byte</span></h1>
                <p id="mode-label" class="text-[9px] text-blue-500 font-bold uppercase tracking-widest mt-1">Mode: Stocking In</p>
            </div>
            <button onclick="toggleView()" id="view-toggle" class="px-4 py-2 bg-slate-100 rounded-full text-[9px] font-black uppercase tracking-widest">Audit View</button>
        </div>
    </header>

    <main class="px-4 py-6">
        <div id="inventory-view" class="max-w-xl mx-auto space-y-6">
            
            <!-- Restock/Sell Toggle -->
            <div class="flex bg-slate-200/50 p-1 rounded-2xl">
                <button onclick="setMode('in')" id="btn-in" class="flex-1 py-3 rounded-xl text-[10px] font-black uppercase bg-white shadow-sm">Restock</button>
                <button onclick="setMode('out')" id="btn-out" class="flex-1 py-3 rounded-xl text-[10px] font-black uppercase text-slate-500">Sell/Move</button>
            </div>

            <!-- Scanner Box -->
            <div class="bg-white p-4 rounded-[32px] shadow-sm border border-slate-100">
                <div id="reader-container" class="relative bg-slate-100 rounded-[24px] overflow-hidden min-h-[300px] flex items-center justify-center">
                    <div id="reader"></div>
                    <div id="scan-guide" class="scan-overlay hidden"></div>
                    <div id="placeholder" class="text-center p-6">
                        <button onclick="startScanner()" class="bg-blue-600 text-white px-8 py-4 rounded-2xl font-black text-xs uppercase tracking-widest shadow-lg active:scale-95">Start Scanner</button>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-2 mt-4">
                    <button onclick="manualEntry()" class="bg-slate-50 py-3 rounded-xl font-black text-[10px] uppercase border border-slate-100 active:bg-slate-200">Manual Entry</button>
                    <button onclick="stopScanner()" class="bg-slate-50 py-3 rounded-xl font-black text-[10px] uppercase border border-slate-100 text-slate-400 active:bg-slate-200">Stop Scan</button>
                </div>
            </div>

            <!-- List -->
            <div class="space-y-3">
                <h3 class="font-black text-slate-400 text-[9px] uppercase tracking-widest px-2">Current Inventory</h3>
                <div id="inventory-list" class="space-y-2"></div>
            </div>

            <!-- Danger Zone -->
            <div class="pt-8 opacity-30">
                <button onclick="confirmReset()" class="text-[8px] font-bold uppercase tracking-widest text-red-500 w-full text-center underline">Reset All Data</button>
            </div>
        </div>

        <!-- Audit View -->
        <div id="audit-view" class="max-w-xl mx-auto hidden space-y-4">
            <div class="bg-slate-900 p-6 rounded-[32px] text-white">
                <h3 class="font-black uppercase italic">Weekly Audit</h3>
                <p class="text-[10px] text-slate-400">Total items moved out this week.</p>
            </div>
            <div id="audit-list" class="space-y-2"></div>
        </div>
    </main>

    <!-- Footer -->
    <div class="fixed bottom-0 left-0 right-0 p-4 bg-white/90 backdrop-blur-md border-t border-slate-100 pb-[calc(1rem+var(--sab))]">
        <div class="max-w-xl mx-auto">
            <button onclick="emailData()" class="w-full bg-blue-600 text-white font-black text-xs uppercase tracking-widest py-5 rounded-full shadow-lg active:scale-95">
                Send Weekly Report
            </button>
        </div>
    </div>

    <script>
        let inventory = JSON.parse(localStorage.getItem('db_inv')) || {};
        let weeklyOut = JSON.parse(localStorage.getItem('db_weekly')) || {};
        let currentMode = 'in';
        let currentView = 'inventory';
        let scanner = null;

        async function startScanner() {
            try {
                // Show guide and hide placeholder
                document.getElementById('placeholder').style.display = 'none';
                document.getElementById('scan-guide').classList.remove('hidden');
                
                scanner = new Html5Qrcode("reader");
                
                // Optimized config for iPhone Barcode scanning
                const config = { 
                    fps: 20, // Increased FPS for faster capture
                    qrbox: { width: 280, height: 180 }, // Slightly larger box
                    aspectRatio: 1.0,
                    experimentalFeatures: {
                        useBarCodeDetectorIfSupported: true
                    }
                };

                await scanner.start(
                    { facingMode: "environment" }, 
                    config, 
                    (decodedText) => {
                        // Success Callback
                        processBarcode(decodedText);
                        if (navigator.vibrate) navigator.vibrate(100); // Longer vibration for success
                        
                        // Briefly pulse the overlay to show detection
                        const guide = document.getElementById('scan-guide');
                        guide.style.borderColor = "#3b82f6";
                        setTimeout(() => guide.style.borderColor = "rgba(255,255,255,0.5)", 500);
                    }
                );
            } catch (err) {
                console.error("Scanner failed", err);
                alert("Camera Error: Please ensure you have granted camera permissions in your browser settings.");
                stopScanner();
            }
        }

        function stopScanner() {
            if (scanner) {
                scanner.stop().finally(() => {
                    document.getElementById('placeholder').style.display = 'block';
                    document.getElementById('scan-guide').classList.add('hidden');
                    document.getElementById('reader').innerHTML = '';
                    scanner = null;
                });
            }
        }

        function processBarcode(code) {
            const presets = {
                "071569000019": "La Colombe Latte",
                "850004940003": "Poppi Strawberry",
                "812425010005": "Celsius Orange"
            };

            let name = presets[code] || "Item " + code;
            if (!inventory[code]) {
                const custom = prompt("New Item Detected! Enter Name:", name);
                if (!custom) return;
                
                const threshold = prompt(`What is the restock alert point for ${custom}?`, "2");
                inventory[code] = { name: custom, qty: 0, threshold: parseInt(threshold) || 2 };
            }
            updateQty(code, currentMode === 'in' ? 1 : -1);
        }

        function manualEntry() {
            const name = prompt("Item Name:");
            if (!name) return;
            const id = "M-" + name.toLowerCase().replace(/\s+/g, '-');
            
            if (!inventory[id]) {
                const threshold = prompt("Restock Point (Alert when qty is below...):", "2");
                inventory[id] = { name: name, qty: 0, threshold: parseInt(threshold) || 2 };
            }
            
            const amtStr = prompt(`How many ${name} to ${currentMode === 'in' ? 'ADD' : 'REMOVE'}?`, "1");
            const amt = parseInt(amtStr) || 0;
            updateQty(id, currentMode === 'in' ? amt : -amt);
        }

        function updateQty(id, delta) {
            if (!inventory[id]) return;
            
            if (delta < 0) {
                const actualRemoval = Math.min(inventory[id].qty, Math.abs(delta));
                inventory[id].qty -= actualRemoval;
                weeklyOut[id] = (weeklyOut[id] || 0) + actualRemoval;
            } else {
                inventory[id].qty += delta;
            }
            
            save();
            showToast(delta > 0 ? `Added ${delta} ${inventory[id].name}` : `Removed ${Math.abs(delta)} ${inventory[id].name}`);
        }

        function save() {
            localStorage.setItem('db_inv', JSON.stringify(inventory));
            localStorage.setItem('db_weekly', JSON.stringify(weeklyOut));
            render();
        }

        function render() {
            const list = document.getElementById('inventory-list');
            list.innerHTML = '';
            
            const keys = Object.keys(inventory).sort((a,b) => inventory[a].name.localeCompare(inventory[b].name));
            
            keys.forEach(id => {
                const item = inventory[id];
                const isLow = item.qty <= item.threshold;
                const div = document.createElement('div');
                div.className = `bg-white p-4 rounded-2xl border flex justify-between items-center transition-all ${isLow ? 'border-red-200 bg-red-50/30' : 'border-slate-100 shadow-sm'}`;
                div.innerHTML = `
                    <div class="truncate pr-2">
                        <p class="font-black text-[10px] uppercase truncate tracking-tight text-slate-800">${item.name}</p>
                        <p class="text-[8px] font-black ${isLow ? 'text-red-500' : 'text-slate-400'} uppercase tracking-widest mt-1">${isLow ? 'RESTOCK NOW' : 'STOCKED'}</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button onclick="updateQty('${id}', -1)" class="w-10 h-10 bg-slate-100 rounded-xl font-bold text-slate-400 active:bg-slate-200">-</button>
                        <span class="text-xs font-black w-6 text-center">${item.qty}</span>
                        <button onclick="updateQty('${id}', 1)" class="w-10 h-10 bg-slate-900 rounded-xl font-bold text-white shadow-lg active:scale-95">+</button>
                    </div>`;
                list.appendChild(div);
            });
        }

        function setMode(m) {
            currentMode = m;
            document.getElementById('mode-label').innerText = `Mode: ${m === 'in' ? 'Stocking In' : 'Selling / Moving Out'}`;
            document.getElementById('mode-label').className = m === 'in' ? 'text-[9px] text-blue-500 font-bold uppercase tracking-widest mt-1' : 'text-[9px] text-orange-500 font-bold uppercase tracking-widest mt-1';
            document.getElementById('btn-in').className = m === 'in' ? 'flex-1 py-3 rounded-xl text-[10px] font-black uppercase bg-white shadow-sm' : 'flex-1 py-3 rounded-xl text-[10px] font-black uppercase text-slate-500';
            document.getElementById('btn-out').className = m === 'out' ? 'flex-1 py-3 rounded-xl text-[10px] font-black uppercase bg-white shadow-sm' : 'flex-1 py-3 rounded-xl text-[10px] font-black uppercase text-slate-500';
        }

        function toggleView() {
            currentView = currentView === 'inventory' ? 'audit' : 'inventory';
            document.getElementById('inventory-view').classList.toggle('hidden');
            document.getElementById('audit-view').classList.toggle('hidden');
            document.getElementById('view-toggle').innerText = currentView === 'inventory' ? 'Audit View' : 'Stock View';
            if(currentView === 'audit') {
                const list = document.getElementById('audit-list');
                list.innerHTML = '';
                Object.keys(weeklyOut).forEach(id => {
                    const div = document.createElement('div');
                    div.className = "bg-white p-4 rounded-2xl border border-slate-100 flex justify-between items-center";
                    div.innerHTML = `<p class="font-black text-[10px] uppercase">${inventory[id]?.name || id}</p><p class="text-xs font-black text-blue-600">${weeklyOut[id]} Sold</p>`;
                    list.appendChild(div);
                });
            }
        }

        function emailData() {
            const date = new Date().toLocaleDateString();
            let body = `THE DAILY BYTE REPORT: ${date}\n\nSALES/MOVEMENTS THIS PERIOD:\n`;
            Object.keys(weeklyOut).forEach(id => {
                body += `- ${inventory[id]?.name || id}: ${weeklyOut[id]} units\n`;
            });
            body += `\nCURRENT STOCK LEVELS:\n`;
            Object.keys(inventory).forEach(id => {
                body += `- ${inventory[id].name}: ${inventory[id].qty} remaining\n`;
            });
            window.location.href = `mailto:elaney.tedder@gmail.com?subject=Byte Report ${date}&body=${encodeURIComponent(body)}`;
        }

        function confirmReset() {
            if(confirm("Wipe all inventory data? This cannot be undone.")) {
                localStorage.clear();
                location.reload();
            }
        }

        function showToast(msg) {
            const t = document.getElementById("toast");
            t.innerText = msg; t.classList.add("show");
            setTimeout(() => t.classList.remove("show"), 2000);
        }

        window.onload = render;
    </script>
</body>
</html>
